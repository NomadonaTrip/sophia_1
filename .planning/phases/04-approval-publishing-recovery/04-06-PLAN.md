---
phase: 04-approval-publishing-recovery
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/sophia/content/models.py
  - backend/src/sophia/approval/router.py
  - backend/src/sophia/publishing/scheduler.py
  - backend/src/sophia/main.py
  - backend/tests/test_publishing.py
  - backend/tests/test_approval_router.py
autonomous: true
gap_closure: true
requirements: [APPR-03, APPR-06]

must_haves:
  truths:
    - "Uploaded image path is persisted to ContentDraft.image_url in the database"
    - "PublishingQueueEntry.image_url is populated from ContentDraft.image_url when a publish job is scheduled"
    - "The auto-publish path succeeds for drafts with uploaded images (executor does not fail at image validation)"
    - "Stale content monitor runs every 30 minutes and broadcasts content_stale events for drafts in review longer than 4 hours"
  artifacts:
    - path: "backend/src/sophia/content/models.py"
      provides: "image_url column on ContentDraft"
      contains: "image_url"
    - path: "backend/src/sophia/approval/router.py"
      provides: "Upload endpoint persists image_url to draft and flushes"
      contains: "draft.image_url"
    - path: "backend/src/sophia/publishing/scheduler.py"
      provides: "schedule_publish copies draft.image_url to entry.image_url"
      contains: "entry.image_url"
    - path: "backend/src/sophia/main.py"
      provides: "register_stale_monitor called with session factory"
      contains: "register_stale_monitor"
  key_links:
    - from: "approval/router.py upload endpoint"
      to: "ContentDraft.image_url"
      via: "draft.image_url = str(filepath); db.commit()"
      pattern: "draft\\.image_url\\s*="
    - from: "publishing/scheduler.py schedule_publish"
      to: "PublishingQueueEntry.image_url"
      via: "copies from draft.image_url or getattr"
      pattern: "entry\\.image_url|image_url.*=.*draft"
    - from: "main.py lifespan"
      to: "stale_monitor.register_stale_monitor"
      via: "uncommented call with _session_factory"
      pattern: "register_stale_monitor\\(scheduler"
---

<objective>
Close two verification gaps from Phase 4 verification:

1. **Image upload not wired to DB (Blocker):** The upload endpoint saves files to disk but never persists `image_url` to `ContentDraft` or `PublishingQueueEntry`. The executor blocks publishing when `entry.image_url` is null, so every auto-publish attempt fails at image validation.

2. **Stale content monitor disabled (Warning):** `register_stale_monitor()` is imported but commented out in `main.py`. Operators get no automated nudge for content stuck in review.

Purpose: Fix the broken auto-publish pipeline and enable stale content monitoring so the Phase 4 success criteria are fully satisfied.
Output: Patched backend files, updated tests, all 73+ tests passing.
</objective>

<execution_context>
@/home/nomad/.claude/get-shit-done/workflows/execute-plan.md
@/home/nomad/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-approval-publishing-recovery/04-VERIFICATION.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From backend/src/sophia/content/models.py:
```python
class ContentDraft(TimestampMixin, Base):
    __tablename__ = "content_drafts"
    # ... existing columns ...
    # NOTE: image_url column is MISSING — must be added
    image_prompt: Mapped[str] = mapped_column(Text, nullable=False)
    # Approval metadata
    approved_at: Mapped[Optional[datetime]]
    publish_mode: Mapped[Optional[str]]
    status: Mapped[str]  # "draft", "in_review", "approved", "rejected", "published", "skipped", "recovered"
```

From backend/src/sophia/approval/models.py:
```python
class PublishingQueueEntry(TimestampMixin, Base):
    __tablename__ = "publishing_queue"
    content_draft_id: Mapped[int]
    client_id: Mapped[int]
    platform: Mapped[str]
    scheduled_at: Mapped[Optional[datetime]]
    publish_mode: Mapped[str]  # "auto" or "manual"
    status: Mapped[str]  # "queued", "publishing", "published", "failed", "paused"
    image_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)  # EXISTS but never populated
```

From backend/src/sophia/approval/router.py (upload endpoint, lines 356-392):
```python
@approval_router.post("/drafts/{draft_id}/upload-image")
async def upload_image_endpoint(draft_id, file, db):
    # Saves file to data/uploads/{draft_id}_{timestamp}_{filename}
    # Returns {"draft_id", "image_path", "filename", "size_bytes"}
    # BUG: Never sets draft.image_url or commits
```

From backend/src/sophia/publishing/scheduler.py (schedule_publish, lines 74-84):
```python
entry = PublishingQueueEntry(
    content_draft_id=draft_id,
    client_id=client_id,
    platform=platform,
    scheduled_at=adjusted_time,
    publish_mode="auto",
    status="queued",
    # BUG: image_url never set from draft
)
```

From backend/src/sophia/publishing/executor.py (lines 75-81):
```python
# 3. Verify image_url exists
if not entry.image_url:
    entry.status = "failed"
    entry.error_message = "Image URL required before publishing"
    # This ALWAYS fires because image_url is never populated
```

From backend/src/sophia/main.py (lines 39-41, 51-53):
```python
# Line 41 — commented out:
# register_stale_monitor(scheduler, db_session_factory)

# Lines 51-53 — session factory pattern (used for Telegram, reuse for stale monitor):
def _session_factory():
    from sophia.db.engine import SessionLocal
    return SessionLocal()
```

From backend/src/sophia/publishing/stale_monitor.py:
```python
def register_stale_monitor(scheduler, db_session_factory, interval_minutes=30):
    scheduler.add_job(check_stale_content, trigger="interval", minutes=interval_minutes,
                      args=[db_session_factory], id="stale_content_monitor", replace_existing=True)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire image_url from upload through publish pipeline</name>
  <files>
    backend/src/sophia/content/models.py
    backend/src/sophia/approval/router.py
    backend/src/sophia/publishing/scheduler.py
    backend/tests/test_publishing.py
    backend/tests/test_approval_router.py
  </files>
  <action>
    Three changes to close the image upload wiring gap:

    **1. Add image_url column to ContentDraft** (backend/src/sophia/content/models.py):
    Add after the `alt_text` column (around line 63), before `suggested_post_time`:
    ```python
    image_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)
    ```
    Import `String` if not already imported (it IS already imported in the file).

    **2. Update upload endpoint to persist image_url** (backend/src/sophia/approval/router.py):
    In `upload_image_endpoint` (line 356-392), after writing the file to disk (line 385), add:
    ```python
    # Persist image path to draft
    draft.image_url = str(filepath)
    db.commit()
    ```
    Also update the return dict to include `"image_url": str(filepath)`.

    **3. Update schedule_publish to copy image_url from draft to entry** (backend/src/sophia/publishing/scheduler.py):
    In `schedule_publish` (around line 75), when creating the `PublishingQueueEntry`, add the `image_url` field:
    ```python
    entry = PublishingQueueEntry(
        content_draft_id=draft_id,
        client_id=client_id,
        platform=platform,
        scheduled_at=adjusted_time,
        publish_mode="auto",
        status="queued",
        image_url=getattr(draft, "image_url", None),  # Copy from draft
    )
    ```
    The `draft` variable is already fetched at line 62 (`draft = db.query(ContentDraft).filter_by(id=draft_id).first()`), so no additional query needed.

    **4. Add test for upload->publish flow** (backend/tests/test_approval_router.py):
    Add a test that verifies the upload endpoint sets `draft.image_url`:
    ```python
    def test_upload_image_sets_draft_image_url(client, db_session):
        # Create a draft
        # Call upload endpoint
        # Verify draft.image_url is set in DB
    ```

    **5. Update _make_draft helper** (backend/tests/test_publishing.py):
    The `_make_draft` helper at line 31-52 accepts `image_url` parameter but never sets it on the draft. Now that ContentDraft has the column, set it:
    ```python
    draft = ContentDraft(
        client_id=client_id,
        platform=platform,
        content_type="feed",
        copy="Test post copy for publishing",
        image_prompt="A scenic photo",
        image_ratio="1:1",
        status=status,
        publish_mode="auto",
        image_url=image_url,  # ADD THIS LINE
    )
    ```

    **6. Add test for schedule_publish copying image_url** (backend/tests/test_publishing.py):
    Add a test verifying that `schedule_publish` copies `draft.image_url` to `entry.image_url`:
    ```python
    @pytest.mark.asyncio
    async def test_schedule_publish_copies_image_url(db_session, sample_client):
        draft = _make_draft(db_session, sample_client.id, image_url="data/uploads/test.png")
        scheduler = create_scheduler(scheduler_db_url="sqlite://")
        entry = await schedule_publish(scheduler, db_session, draft.id, "facebook",
                                        datetime.now(timezone.utc) + timedelta(hours=1))
        assert entry.image_url == "data/uploads/test.png"
    ```

    Do NOT change any existing passing tests. The changes to `_make_draft` are additive (existing callers pass `image_url` with a default value already).
  </action>
  <verify>
    <automated>cd /mnt/e/TOOLMAKER/PYTHON/sophia/backend && python -m pytest tests/test_publishing.py tests/test_approval_router.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - ContentDraft model has image_url column (String(500), nullable)
    - Upload endpoint sets draft.image_url = filepath and commits
    - schedule_publish copies draft.image_url to entry.image_url
    - New test confirms upload sets draft.image_url
    - New test confirms schedule_publish copies image_url
    - All existing 73 tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire stale content monitor in application lifespan</name>
  <files>
    backend/src/sophia/main.py
  </files>
  <action>
    Wire the stale content monitor in the FastAPI lifespan. The session factory pattern already exists (lines 51-53 for Telegram). Reuse it.

    **In `main.py` lifespan function**, make these changes:

    1. Move the `_session_factory` definition BEFORE the stale monitor call (currently it's inside the Telegram block). Define it once at the top of the lifespan, right after `scheduler.start()`:
    ```python
    scheduler.start()

    # Lazy session factory -- reused by stale monitor and Telegram bot
    def _session_factory():
        from sophia.db.engine import SessionLocal
        return SessionLocal()

    # Register stale content monitor (runs every 30 min)
    register_stale_monitor(scheduler, _session_factory)

    app.state.scheduler = scheduler
    ```

    2. Remove the duplicate `_session_factory` definition from inside the Telegram block (lines 51-53) and use the one defined above. Pass `_session_factory` directly to `build_telegram_app` where `session_factory=_session_factory` is already used.

    3. The import `from sophia.publishing.stale_monitor import register_stale_monitor` already exists at line 16. No change needed there.

    4. Remove the comment `# db_session_factory placeholder -- wired when full app assembled` (line 40) since it's now wired.

    The key constraint: `_session_factory` uses lazy import (`from sophia.db.engine import SessionLocal`) inside the function body to avoid slow NTFS imports at startup. This pattern is already proven to work for Telegram. Do NOT import SessionLocal at module level.
  </action>
  <verify>
    <automated>cd /mnt/e/TOOLMAKER/PYTHON/sophia/backend && python -m pytest tests/ -x -v 2>&1 | tail -20</automated>
  </verify>
  <done>
    - register_stale_monitor is called (not commented out) in main.py lifespan
    - _session_factory is defined once and shared between stale monitor and Telegram bot
    - No duplicate _session_factory definitions
    - All 73+ tests pass
    - uvicorn can start without import errors (no module-level NTFS-heavy imports added)
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `cd backend && python -m pytest tests/ -x -v` -- all tests pass (73+ including new ones)
2. Grep confirms image_url column exists on ContentDraft: `grep "image_url" backend/src/sophia/content/models.py`
3. Grep confirms upload endpoint sets draft.image_url: `grep "draft.image_url" backend/src/sophia/approval/router.py`
4. Grep confirms schedule_publish copies image_url: `grep "image_url" backend/src/sophia/publishing/scheduler.py`
5. Grep confirms stale monitor is wired (not commented): `grep "register_stale_monitor" backend/src/sophia/main.py` -- no `#` prefix
6. Verify no module-level heavy imports added: `grep -n "^from sophia.db.engine" backend/src/sophia/main.py` -- should return 0 matches
</verification>

<success_criteria>
- Image upload -> publish pipeline works end-to-end: upload sets draft.image_url, schedule_publish copies to entry.image_url, executor finds image_url and proceeds
- Stale content monitor is registered and will fire every 30 minutes in production
- All existing tests pass, plus 2+ new tests for the gap fixes
- VERIFICATION.md Gap 1 (Blocker) and Gap 2 (Warning) are both resolved
</success_criteria>

<output>
After completion, create `.planning/phases/04-approval-publishing-recovery/04-06-SUMMARY.md`
</output>
